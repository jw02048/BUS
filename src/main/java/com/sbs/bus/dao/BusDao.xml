<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sbs.bus.dao.BusDao">
	<select id="getLineId" parameterType="map" resultType="Integer">
		SELECT line.id
		FROM line
		WHERE `departure` = #{departure} AND `destination` = #{destination}
	</select>
	
	<select id="getServiceList" parameterType="map" resultMap="Service">
		SELECT S.*, (B.totalSeat-COUNT(T.id)) AS "remainingSeats"
		FROM (
		    SELECT *
		    FROM service
		    WHERE lineId = #{lineId}
		) AS S
		LEFT JOIN bus AS B
		ON S.busId = B.id
		LEFT JOIN (
		    SELECT *
		    FROM ticket
		    WHERE departureDate = #{departureDate}
		) AS T
		ON T.serviceId = S.id
		GROUP BY S.id
	</select>
	

	
	<resultMap id="Service" type="com.sbs.bus.dto.Service">
		<id property="id" column="id"/>
		<id property="regDate" column="regDate"/>
		<id property="departureTime" column="departureTime"/>
		<id property="estimatedTime" column="estimatedTime"/>
		<id property="busId" column="busId"/>
		<id property="lineId" column="lineId"/>
		<association property="extra" javaType="HashMap">
			<id property="remainingSeats" column="remainingSeats"/>
		</association>
	</resultMap>
</mapper>